<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Personal Assistant</title>
<meta name="theme-color" content="#f8f5f0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700;800&family=Crimson+Pro:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
:root {
  --bg: #f8f5f0;
  --bg2: #f0ebe3;
  --surface: #ffffff;
  --surface2: #faf8f5;
  --border: #e4ddd3;
  --border-light: #ede8e0;
  --text: #2c2518;
  --text2: #6b5e4f;
  --text3: #a0947f;
  --accent: #b8956a;
  --accent2: #a07d55;
  --accent-bg: rgba(184,149,106,0.1);
  --accent-bg2: rgba(184,149,106,0.18);
  --red: #c75c4a;
  --red-bg: rgba(199,92,74,0.08);
  --orange: #d49a3e;
  --orange-bg: rgba(212,154,62,0.08);
  --blue: #5a8db5;
  --blue-bg: rgba(90,141,181,0.08);
  --green: #5a9e6f;
  --green-bg: rgba(90,158,111,0.08);
  --purple: #8b7ab8;
  --purple-bg: rgba(139,122,184,0.08);
  --r: 14px;
  --r-sm: 10px;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
html { height:100%; }
body {
  font-family: 'Noto Sans TC', -apple-system, sans-serif;
  background: var(--bg); color: var(--text);
  min-height:100%; padding-bottom: calc(78px + var(--safe-bottom));
  -webkit-font-smoothing: antialiased;
}

/* Subtle texture */
body::before {
  content:'';
  position:fixed; inset:0;
  background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none'%3E%3Cg fill='%23b8956a' fill-opacity='0.025'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  pointer-events:none; z-index:0;
}

/* ========== BOTTOM NAV ========== */
.bottom-nav {
  position:fixed; bottom:0; left:0; right:0;
  background: rgba(248,245,240,0.92);
  backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
  display:flex; justify-content:space-around;
  padding: 6px 0 calc(6px + var(--safe-bottom));
  z-index:100;
}
.nav-btn {
  display:flex; flex-direction:column; align-items:center;
  padding:4px 18px; border:none; background:transparent;
  color:var(--text3); font-family:inherit; font-size:10px;
  font-weight:500; cursor:pointer; transition:0.2s;
  position:relative;
}
.nav-btn .nav-icon {
  width:52px; height:28px; border-radius:14px;
  display:flex; align-items:center; justify-content:center;
  font-size:17px; margin-bottom:2px; transition:0.25s;
}
.nav-btn.active { color:var(--accent2); font-weight:600; }
.nav-btn.active .nav-icon { background:var(--accent-bg2); }
.nav-btn .badge {
  position:absolute; top:0; right:8px;
  background:var(--red); color:white;
  font-size:9px; font-weight:700;
  min-width:16px; height:16px; border-radius:8px;
  display:flex; align-items:center; justify-content:center;
}

/* ========== PAGE ========== */
.page { position:relative; z-index:1; padding:0 16px; }

.page-head { padding:20px 0 14px; }
.page-head .greeting {
  font-size:13px; color:var(--text3); font-weight:400;
  margin-bottom:2px;
}
.page-head h1 {
  font-family:'Crimson Pro', serif;
  font-size:30px; font-weight:700;
  color:var(--text); letter-spacing:-0.5px;
}
.page-head .sub {
  font-size:12px; color:var(--text3);
  font-family:'IBM Plex Mono', monospace;
  margin-top:4px;
}

/* ========== PANELS ========== */
.panel { display:none; animation:fadeUp 0.3s ease; }
.panel.active { display:block; }
@keyframes fadeUp { from{opacity:0;transform:translateY(14px)} to{opacity:1;transform:translateY(0)} }

/* ========== STATS SCROLL ========== */
.stats-scroll {
  display:flex; gap:10px;
  overflow-x:auto; padding:4px 0 18px;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
}
.stats-scroll::-webkit-scrollbar { display:none; }

.stat-pill {
  display:flex; align-items:center; gap:10px;
  padding:14px 18px;
  background:var(--surface);
  border:1px solid var(--border-light);
  border-radius:28px;
  flex-shrink:0; min-width:128px;
  box-shadow:0 1px 3px rgba(0,0,0,0.03);
}
.stat-pill .pill-icon {
  width:36px; height:36px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  font-size:15px;
}
.stat-pill .pill-num {
  font-family:'Crimson Pro', serif;
  font-size:24px; font-weight:700;
}
.stat-pill .pill-label { font-size:10px; color:var(--text3); }

.stat-pill.s1 .pill-icon { background:var(--accent-bg); }
.stat-pill.s1 .pill-num { color:var(--accent); }
.stat-pill.s2 .pill-icon { background:var(--orange-bg); }
.stat-pill.s2 .pill-num { color:var(--orange); }
.stat-pill.s3 .pill-icon { background:var(--green-bg); }
.stat-pill.s3 .pill-num { color:var(--green); }
.stat-pill.s4 .pill-icon { background:var(--red-bg); }
.stat-pill.s4 .pill-num { color:var(--red); }

/* ========== SECTION ========== */
.section { margin-bottom:24px; }
.section-head {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:10px; padding:0 2px;
}
.section-title {
  font-family:'Crimson Pro', serif;
  font-size:18px; font-weight:600;
  display:flex; align-items:center; gap:8px;
}
.section-title .line { width:20px; height:2px; background:var(--accent); }
.section-more {
  font-size:12px; color:var(--accent); background:none;
  border:none; cursor:pointer; font-family:inherit; font-weight:500;
}

/* ========== CARD LIST ========== */
.card-list { display:flex; flex-direction:column; gap:8px; }

.card-item {
  display:flex; align-items:center; gap:12px;
  padding:16px;
  background:var(--surface);
  border:1px solid var(--border-light);
  border-radius:var(--r);
  transition:0.15s;
  cursor:pointer;
  box-shadow:0 1px 3px rgba(0,0,0,0.02);
}
.card-item:active { background:var(--surface2); }

/* Schedule accent bar */
.sched-accent {
  width:3px; border-radius:2px;
  align-self:stretch; min-height:30px; flex-shrink:0;
}
.acc-work { background:var(--blue); }
.acc-meeting { background:var(--orange); }
.acc-personal { background:var(--green); }
.acc-health { background:var(--red); }
.acc-other { background:var(--purple); }

.card-body { flex:1; min-width:0; }
.card-title { font-size:14px; font-weight:500; margin-bottom:3px; }
.card-meta { font-size:11px; color:var(--text3); display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

.sched-cat {
  display:inline-block; padding:2px 8px;
  border-radius:4px; font-size:10px; font-weight:600;
}
.cat-work { background:var(--blue-bg); color:var(--blue); }
.cat-meeting { background:var(--orange-bg); color:var(--orange); }
.cat-personal { background:var(--green-bg); color:var(--green); }
.cat-health { background:var(--red-bg); color:var(--red); }
.cat-other { background:var(--purple-bg); color:var(--purple); }

.time-block { text-align:right; flex-shrink:0; }
.time-block .time-main {
  font-family:'IBM Plex Mono', monospace;
  font-size:14px; font-weight:500; color:var(--accent);
}
.time-block .time-end {
  font-size:10px; color:var(--text3);
  font-family:'IBM Plex Mono', monospace;
}

.chevron { color:var(--text3); font-size:16px; flex-shrink:0; }

/* ========== TODO ========== */
.todo-check {
  width:22px; height:22px; border-radius:50%;
  border:2px solid var(--border); flex-shrink:0;
  display:flex; align-items:center; justify-content:center;
  font-size:11px; color:transparent; cursor:pointer;
  transition:0.2s;
}
.todo-check:hover { border-color:var(--accent); }
.card-item.done .todo-check {
  background:var(--green); border-color:var(--green); color:white;
}
.card-item.done .card-title { text-decoration:line-through; color:var(--text3); }
.card-item.done { opacity:0.4; }

.pri-tag {
  padding:2px 8px; border-radius:4px;
  font-size:10px; font-weight:600;
}
.pri-ui { background:var(--red-bg); color:var(--red); }
.pri-i { background:var(--orange-bg); color:var(--orange); }
.pri-u { background:var(--blue-bg); color:var(--blue); }
.pri-n { background:var(--purple-bg); color:var(--purple); }
.overdue { color:var(--red) !important; font-weight:600; }

/* ========== FILTERS ========== */
.filter-scroll {
  display:flex; gap:6px;
  overflow-x:auto; padding:2px 0 14px;
  scrollbar-width:none;
}
.filter-scroll::-webkit-scrollbar { display:none; }

.chip {
  padding:7px 16px; border-radius:20px;
  background:var(--surface); color:var(--text3);
  border:1px solid var(--border-light);
  font-family:inherit; font-size:12px; font-weight:500;
  cursor:pointer; white-space:nowrap; flex-shrink:0;
  transition:0.2s;
  box-shadow:0 1px 2px rgba(0,0,0,0.02);
}
.chip.on {
  background:var(--text); color:var(--bg);
  border-color:var(--text);
}

/* ========== QUICK ADD ========== */
.quick-add { display:flex; gap:8px; margin-bottom:14px; }
.quick-add input {
  flex:1; padding:13px 16px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--r); color:var(--text);
  font-family:inherit; font-size:14px;
  outline:none; transition:0.2s;
}
.quick-add input:focus { border-color:var(--accent); }
.quick-add input::placeholder { color:var(--text3); }
.quick-add .add-btn {
  width:48px; border-radius:var(--r);
  background:var(--text); color:var(--bg); border:none;
  font-size:22px; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
}

/* ========== DATE NAV ========== */
.date-nav {
  display:flex; align-items:center; gap:8px; margin-bottom:16px;
}
.dn-btn {
  width:36px; height:36px; border-radius:var(--r-sm);
  background:var(--surface); border:1px solid var(--border);
  color:var(--text2); cursor:pointer; font-size:15px;
  display:flex; align-items:center; justify-content:center;
}
.dn-current {
  flex:1;
  font-family:'Crimson Pro', serif;
  font-size:17px; font-weight:600;
}
.dn-today {
  padding:6px 14px; border-radius:20px;
  background:var(--accent-bg); color:var(--accent);
  font-size:12px; font-weight:500; border:none;
  cursor:pointer; font-family:inherit;
}

/* ========== NOTES ========== */
.note-scroll {
  display:flex; gap:10px;
  overflow-x:auto; padding:4px 0 12px;
  scrollbar-width:none;
}
.note-scroll::-webkit-scrollbar { display:none; }

.notes-grid {
  display:grid; grid-template-columns:repeat(2, 1fr); gap:10px;
}

.note-card {
  background:var(--surface);
  border:1px solid var(--border-light);
  border-radius:var(--r); padding:18px;
  cursor:pointer; transition:0.2s;
  box-shadow:0 1px 3px rgba(0,0,0,0.02);
  min-width:180px; flex-shrink:0;
}
.note-card:active { background:var(--surface2); }
.note-card h4 {
  font-family:'Crimson Pro', serif;
  font-size:15px; font-weight:600; margin-bottom:6px;
}
.note-card p {
  font-size:11px; color:var(--text2); line-height:1.7;
  display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden;
}
.note-tags { display:flex; gap:4px; margin-top:8px; flex-wrap:wrap; }
.note-tag {
  font-size:9px; padding:2px 7px; border-radius:4px;
  border:1px solid var(--border); color:var(--text3);
}

/* ========== FAB ========== */
.fab {
  position:fixed;
  bottom: calc(88px + var(--safe-bottom));
  right:18px;
  width:52px; height:52px; border-radius:50%;
  background:var(--text); color:var(--bg); border:none;
  font-size:26px; cursor:pointer;
  box-shadow:0 4px 16px rgba(44,37,24,0.25);
  display:flex; align-items:center; justify-content:center;
  z-index:50; transition:0.2s;
}
.fab:active { transform:scale(0.9); }

/* ========== MODAL ========== */
.modal-overlay {
  display:none; position:fixed; inset:0;
  background:rgba(44,37,24,0.4);
  backdrop-filter:blur(4px);
  z-index:200; align-items:flex-end; justify-content:center;
}
.modal-overlay.active { display:flex; }

.modal {
  background:var(--bg);
  border-radius:20px 20px 0 0;
  width:100%; max-width:500px;
  max-height:88vh; overflow-y:auto;
  animation:slideSheet 0.3s ease;
  padding-bottom: var(--safe-bottom);
}
@keyframes slideSheet { from{transform:translateY(100%)} to{transform:translateY(0)} }

.modal-handle {
  width:36px; height:4px; border-radius:2px;
  background:var(--border); margin:10px auto 0;
}
.modal-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:16px 20px 10px;
}
.modal-header h3 {
  font-family:'Crimson Pro', serif;
  font-size:20px; font-weight:600;
}
.modal-close {
  width:32px; height:32px; border:none;
  background:var(--bg2); color:var(--text2);
  border-radius:50%; cursor:pointer; font-size:16px;
  display:flex; align-items:center; justify-content:center;
}
.modal-body { padding:10px 20px 20px; }
.modal-footer {
  padding:12px 20px 16px;
  border-top:1px solid var(--border);
  display:flex; gap:8px;
}

/* ========== FORM ========== */
.form-group { margin-bottom:14px; }
.form-label {
  display:block; font-size:11px; font-weight:600;
  color:var(--text3); margin-bottom:5px;
  text-transform:uppercase; letter-spacing:0.5px;
}
.form-input, .form-select, .form-textarea {
  width:100%; padding:12px 14px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:var(--r-sm); color:var(--text);
  font-family:inherit; font-size:14px;
  outline:none; transition:0.2s;
}
.form-input:focus, .form-select:focus, .form-textarea:focus {
  border-color:var(--accent);
}
.form-textarea { resize:vertical; min-height:80px; }
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

/* Buttons */
.btn {
  padding:12px 20px; border:none; border-radius:var(--r-sm);
  font-family:inherit; font-size:14px; font-weight:600;
  cursor:pointer; transition:0.2s; flex:1; text-align:center;
}
.btn-primary { background:var(--text); color:var(--bg); }
.btn-primary:active { opacity:0.8; }
.btn-secondary { background:var(--bg2); color:var(--text2); }

/* ========== TOAST ========== */
.toast-container {
  position:fixed; top:20px; left:16px; right:16px;
  z-index:300; display:flex; flex-direction:column; gap:8px;
}
.toast {
  padding:14px 18px;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--r);
  font-size:13px; font-weight:500;
  box-shadow:0 8px 24px rgba(0,0,0,0.1);
  animation:toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
  display:flex; align-items:center; gap:8px;
}
.toast.success { border-left:3px solid var(--green); }
.toast.error { border-left:3px solid var(--red); }
.toast.info { border-left:3px solid var(--accent); }
@keyframes toastIn { from{opacity:0;transform:translateY(-10px)} to{opacity:1;transform:translateY(0)} }
@keyframes toastOut { from{opacity:1} to{opacity:0;transform:translateY(-10px)} }

/* ========== SETTINGS ========== */
.settings-card {
  background:var(--surface);
  border:1px solid var(--border-light);
  border-radius:var(--r);
  padding:18px;
  margin-bottom:12px;
  box-shadow:0 1px 3px rgba(0,0,0,0.02);
}
.settings-card h4 {
  font-family:'Crimson Pro', serif;
  font-size:16px; font-weight:600; margin-bottom:4px;
}
.settings-card p {
  font-size:11px; color:var(--text3); margin-bottom:14px; line-height:1.5;
}
.settings-btn {
  padding:10px 18px; border-radius:var(--r-sm);
  font-family:inherit; font-size:12px; font-weight:600;
  cursor:pointer; transition:0.2s; border:1px solid var(--border);
  background:var(--surface); color:var(--text2);
}
.settings-btn:active { background:var(--bg2); }
.settings-btn.danger { color:var(--red); border-color:rgba(199,92,74,0.3); }

.status-dot {
  display:inline-flex; align-items:center; gap:5px;
  font-size:11px; padding:3px 10px; border-radius:12px;
}
.status-on { background:var(--green-bg); color:var(--green); }
.status-off { background:var(--red-bg); color:var(--red); }

/* ========== EMPTY ========== */
.empty {
  text-align:center; padding:40px 20px; color:var(--text3);
}
.empty .icon { font-size:36px; margin-bottom:8px; opacity:0.3; }
.empty .msg { font-size:13px; }

/* ========== CALENDAR ========== */
.cal-header {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:12px;
}
.cal-header .cal-title {
  font-family:'Crimson Pro', serif;
  font-size:18px; font-weight:600;
}
.cal-header .cal-nav { display:flex; gap:6px; align-items:center; }
.cal-nav-btn {
  width:32px; height:32px; border-radius:8px;
  background:var(--surface); border:1px solid var(--border-light);
  color:var(--text2); cursor:pointer; font-size:14px;
  display:flex; align-items:center; justify-content:center;
}
.cal-today-btn {
  padding:5px 12px; border-radius:16px;
  background:var(--accent-bg); color:var(--accent);
  font-size:11px; font-weight:600; border:none;
  cursor:pointer; font-family:inherit;
}

.cal-grid {
  background:var(--surface);
  border:1px solid var(--border-light);
  border-radius:var(--r);
  padding:12px 8px;
  box-shadow:0 1px 3px rgba(0,0,0,0.02);
  margin-bottom:16px;
}
.cal-weekdays {
  display:grid; grid-template-columns:repeat(7,1fr);
  text-align:center; margin-bottom:6px;
}
.cal-weekdays span {
  font-size:10px; font-weight:600; color:var(--text3);
  padding:4px 0; text-transform:uppercase;
}
.cal-days {
  display:grid; grid-template-columns:repeat(7,1fr);
  gap:2px; text-align:center;
}
.cal-day {
  position:relative;
  width:100%; aspect-ratio:1;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  border-radius:10px; cursor:pointer;
  font-size:13px; font-weight:500;
  transition:0.15s; border:none; background:transparent;
  color:var(--text); font-family:inherit;
}
.cal-day:active { background:var(--bg2); }
.cal-day.other-month { color:var(--text3); opacity:0.4; }
.cal-day.today {
  background:var(--accent-bg2);
  color:var(--accent); font-weight:700;
}
.cal-day.selected {
  background:var(--text); color:var(--bg); font-weight:700;
}
.cal-day.has-event::after {
  content:''; position:absolute; bottom:4px;
  width:4px; height:4px; border-radius:50%;
  background:var(--accent);
}
.cal-day.today.has-event::after { background:var(--accent2); }
.cal-day.selected.has-event::after { background:var(--bg); }

/* ========== FAVORITES (å¸¸ç”¨è¡Œç¨‹) ========== */
.fav-section { margin-bottom:18px; }
.fav-section .section-head { margin-bottom:8px; }
.fav-scroll {
  display:flex; gap:8px;
  overflow-x:auto; padding:2px 0 8px;
  scrollbar-width:none;
}
.fav-scroll::-webkit-scrollbar { display:none; }

.fav-chip {
  display:flex; align-items:center; gap:6px;
  padding:10px 14px;
  background:var(--surface);
  border:1px solid var(--border-light);
  border-radius:12px;
  cursor:pointer; white-space:nowrap; flex-shrink:0;
  transition:0.15s; font-family:inherit; font-size:12px;
  box-shadow:0 1px 2px rgba(0,0,0,0.02);
  color:var(--text);
}
.fav-chip:active { background:var(--bg2); }
.fav-chip .fav-icon { font-size:14px; }
.fav-chip .fav-time {
  font-family:'IBM Plex Mono', monospace;
  font-size:10px; color:var(--text3);
}
.fav-chip-add {
  border-style:dashed; border-color:var(--text3);
  color:var(--text3); font-weight:500;
}

/* ========== MULTI-DAY PICKER ========== */
.multi-cal-grid {
  display:grid; grid-template-columns:repeat(7,1fr);
  gap:3px; text-align:center;
  margin-bottom:12px;
}
.multi-cal-day {
  width:100%; aspect-ratio:1;
  display:flex; align-items:center; justify-content:center;
  border-radius:10px; cursor:pointer;
  font-size:13px; font-weight:500;
  transition:0.15s; border:2px solid transparent;
  background:var(--surface); color:var(--text);
  font-family:inherit;
}
.multi-cal-day:active { transform:scale(0.92); }
.multi-cal-day.other-month { color:var(--text3); opacity:0.3; pointer-events:none; }
.multi-cal-day.today { border-color:var(--accent); color:var(--accent); }
.multi-cal-day.picked {
  background:var(--text); color:var(--bg);
  border-color:var(--text); font-weight:700;
}
.multi-cal-day.today.picked { border-color:var(--text); }

.picked-summary {
  display:flex; flex-wrap:wrap; gap:6px;
  margin-bottom:12px; min-height:28px;
}
.picked-tag {
  display:flex; align-items:center; gap:4px;
  padding:4px 10px; border-radius:8px;
  background:var(--accent-bg); color:var(--accent);
  font-size:11px; font-weight:600;
}
.picked-tag .remove-day {
  cursor:pointer; opacity:0.6;
  font-size:13px; margin-left:2px;
}
.picked-tag .remove-day:hover { opacity:1; }

/* ========== TIME SLOT GRID ========== */
.time-slots-label {
  font-size:11px; font-weight:600; color:var(--text3);
  text-transform:uppercase; letter-spacing:0.5px;
  margin-bottom:8px;
}
.time-slots-grid {
  display:grid; grid-template-columns:repeat(4,1fr);
  gap:6px; margin-bottom:14px;
}
.time-slot {
  padding:10px 4px; border-radius:8px;
  background:var(--surface); border:1px solid var(--border-light);
  cursor:pointer; text-align:center;
  font-family:'IBM Plex Mono', monospace;
  font-size:12px; color:var(--text2);
  transition:0.15s; font-weight:500;
}
.time-slot:active { transform:scale(0.95); }
.time-slot.picked {
  background:var(--text); color:var(--bg);
  border-color:var(--text); font-weight:600;
}
.time-custom-row {
  display:flex; gap:8px; align-items:center;
  margin-bottom:14px;
}
.time-custom-row label {
  font-size:11px; color:var(--text3); font-weight:500; white-space:nowrap;
}
.time-custom-row input {
  flex:1; padding:10px 12px;
  background:var(--surface); border:1px solid var(--border);
  border-radius:8px; color:var(--text);
  font-family:inherit; font-size:13px;
  outline:none;
}
.time-custom-row input:focus { border-color:var(--accent); }

/* Fav manage modal */
.fav-manage-item {
  display:flex; align-items:center; gap:10px;
  padding:12px 0;
  border-bottom:1px solid var(--border-light);
}
.fav-manage-item:last-child { border-bottom:none; }
.fav-manage-body { flex:1; min-width:0; }
.fav-manage-title { font-size:14px; font-weight:500; }
.fav-manage-meta { font-size:11px; color:var(--text3); margin-top:2px; }
.fav-manage-del {
  width:32px; height:32px; border-radius:8px;
  background:var(--red-bg); color:var(--red);
  border:none; cursor:pointer; font-size:14px;
  display:flex; align-items:center; justify-content:center;
}

/* ========== GOOGLE CALENDAR EVENTS ========== */
.gcal-accent { background: linear-gradient(135deg, #4285f4, #34a853) !important; }
/* Google Calendar colorId accent overrides */
.gcal-c1 { background: #7986CB !important; }
.gcal-c2 { background: #33B679 !important; }
.gcal-c3 { background: #8E24AA !important; }
.gcal-c4 { background: #E67C73 !important; }
.gcal-c5 { background: #F6BF26 !important; }
.gcal-c6 { background: #F4511E !important; }
.gcal-c7 { background: #039BE5 !important; }
.gcal-c8 { background: #616161 !important; }
.gcal-c9 { background: #3F51B5 !important; }
.gcal-c10 { background: #0B8043 !important; }
.gcal-c11 { background: #D50000 !important; }
.gcal-badge {
  display:inline-flex; align-items:center; gap:3px;
  padding:2px 8px; border-radius:6px;
  background:rgba(66,133,244,0.1); color:#4285f4;
  font-size:10px; font-weight:600;
}
.gcal-badge svg { width:10px; height:10px; }
.card-item.gcal-item { opacity:0.88; }
.card-item.gcal-item:active { opacity:1; }

/* Google sign-in button */
.g-signin-btn {
  display:flex; align-items:center; justify-content:center; gap:10px;
  width:100%; padding:12px; border-radius:var(--r-sm);
  background:#fff; border:1px solid #dadce0;
  color:#3c4043; font-size:14px; font-weight:500;
  cursor:pointer; font-family:inherit;
  box-shadow:0 1px 2px rgba(0,0,0,0.08);
  transition:0.15s;
}
.g-signin-btn:active { background:#f8f9fa; }
.g-signin-btn svg { width:18px; height:18px; flex-shrink:0; }
.g-signout-btn {
  padding:10px 16px; border-radius:var(--r-sm);
  background:var(--red-bg); color:var(--red);
  border:none; font-size:13px; cursor:pointer;
  font-family:inherit; font-weight:500;
}
.g-user-row {
  display:flex; align-items:center; gap:10px;
  padding:10px 14px; background:var(--bg2);
  border-radius:var(--r-sm); margin-bottom:12px;
}
.g-user-avatar {
  width:36px; height:36px; border-radius:50%;
  background:var(--accent-bg); color:var(--accent);
  display:flex; align-items:center; justify-content:center;
  font-size:16px; font-weight:700;
}
.g-user-info { flex:1; min-width:0; }
.g-user-name { font-size:14px; font-weight:600; }
.g-user-email { font-size:11px; color:var(--text3); overflow:hidden; text-overflow:ellipsis; }
.g-sync-status {
  display:flex; align-items:center; gap:6px;
  font-size:12px; color:var(--text3);
  margin-top:8px;
}
.g-sync-status .spinner {
  width:14px; height:14px; border:2px solid var(--border);
  border-top-color:var(--accent); border-radius:50%;
  animation:spin 0.8s linear infinite;
}
@keyframes spin { to { transform:rotate(360deg); } }

/* ========== RESPONSIVE ========== */
@supports (padding-bottom: env(safe-area-inset-bottom)) {
  body { padding-bottom: calc(78px + env(safe-area-inset-bottom)); }
}
</style>
</head>
<body>

<div class="page">
  <!-- ===================== DASHBOARD ===================== -->
  <div class="panel active" id="p-dashboard">
    <div class="page-head">
      <div class="greeting" id="greetingText"></div>
      <h1 id="dashTitle">Today</h1>
      <div class="sub" id="hDate"></div>
    </div>

    <div class="stats-scroll">
      <div class="stat-pill s1"><div class="pill-icon">ğŸ“…</div><div><div class="pill-num" id="statEvents">0</div><div class="pill-label">ä»Šæ—¥è¡Œç¨‹</div></div></div>
      <div class="stat-pill s2"><div class="pill-icon">âš¡</div><div><div class="pill-num" id="statTodos">0</div><div class="pill-label">å¾…è¾¦äº‹é …</div></div></div>
      <div class="stat-pill s3"><div class="pill-icon">âœ“</div><div><div class="pill-num" id="statDone">0</div><div class="pill-label">å·²å®Œæˆ</div></div></div>
      <div class="stat-pill s4"><div class="pill-icon">âš </div><div><div class="pill-num" id="statOverdue">0</div><div class="pill-label">å·²éæœŸ</div></div></div>
    </div>

    <div class="section">
      <div class="section-head">
        <div class="section-title"><span class="line"></span> Today's Schedule</div>
        <button class="section-more" onclick="sw('schedule',1)">å…¨éƒ¨ â†’</button>
      </div>
      <div class="card-list" id="dashSchedule"></div>
    </div>

    <div class="section">
      <div class="section-head">
        <div class="section-title"><span class="line"></span> Urgent Tasks</div>
        <button class="section-more" onclick="sw('todos',2)">å…¨éƒ¨ â†’</button>
      </div>
      <div class="card-list" id="dashTodos"></div>
    </div>

    <div class="section">
      <div class="section-head">
        <div class="section-title"><span class="line"></span> Recent Notes</div>
        <button class="section-more" onclick="sw('notes',3)">å…¨éƒ¨ â†’</button>
      </div>
      <div class="note-scroll" id="dashNotes"></div>
    </div>
  </div>

  <!-- ===================== SCHEDULE ===================== -->
  <div class="panel" id="p-schedule">
    <div class="page-head"><h1>Schedule</h1></div>

    <!-- Calendar -->
    <div class="cal-grid">
      <div class="cal-header">
        <div class="cal-title" id="calTitle"></div>
        <div class="cal-nav">
          <button class="cal-today-btn" onclick="calGoToday()">ä»Šå¤©</button>
          <button class="cal-nav-btn" onclick="calNav(-1)">â—‚</button>
          <button class="cal-nav-btn" onclick="calNav(1)">â–¸</button>
        </div>
      </div>
      <div class="cal-weekdays"><span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span></div>
      <div class="cal-days" id="calDays"></div>
    </div>

    <!-- å¸¸ç”¨è¡Œç¨‹ -->
    <div class="fav-section">
      <div class="section-head">
        <div class="section-title"><span class="line"></span> å¸¸ç”¨è¡Œç¨‹</div>
        <button class="section-more" onclick="openFavManage()">ç®¡ç† â†’</button>
      </div>
      <div class="fav-scroll" id="favScroll"></div>
    </div>

    <!-- Day schedule list -->
    <div class="section">
      <div class="section-head">
        <div class="section-title" id="dayListTitle"></div>
      </div>
      <div class="card-list" id="scheduleList"></div>
    </div>
  </div>

  <!-- ===================== TODOS ===================== -->
  <div class="panel" id="p-todos">
    <div class="page-head"><h1>Tasks</h1></div>
    <div class="quick-add">
      <input type="text" id="quickInput" placeholder="æ–°å¢å¾…è¾¦äº‹é …..." onkeydown="if(event.key==='Enter')quickAdd()">
      <button class="add-btn" onclick="quickAdd()">+</button>
    </div>
    <div class="filter-scroll">
      <button class="chip on" onclick="setFilter('all',this)">å…¨éƒ¨</button>
      <button class="chip" onclick="setFilter('urgent-important',this)">ğŸ”´ ç·Šæ€¥é‡è¦</button>
      <button class="chip" onclick="setFilter('important',this)">ğŸŸ¡ é‡è¦</button>
      <button class="chip" onclick="setFilter('urgent',this)">ğŸ”µ ç·Šæ€¥</button>
      <button class="chip" onclick="setFilter('normal',this)">ğŸŸ£ ä¸€èˆ¬</button>
      <button class="chip" onclick="setFilter('completed',this)">âœ“ å·²å®Œæˆ</button>
    </div>
    <div class="card-list" id="todoList"></div>
  </div>

  <!-- ===================== NOTES ===================== -->
  <div class="panel" id="p-notes">
    <div class="page-head"><h1>Notes</h1></div>
    <div class="notes-grid" id="notesList"></div>
  </div>

  <!-- ===================== SETTINGS ===================== -->
  <div class="panel" id="p-settings">
    <div class="page-head"><h1>Settings</h1></div>

    <div class="settings-card">
      <h4>ğŸ“… Google Calendar ç›´é€£</h4>
      <p>ç›´æ¥è®€å– Google æ—¥æ›†äº‹ä»¶ï¼Œåœ¨è¡Œç¨‹é é¢åˆä½µé¡¯ç¤º</p>
      <div id="gcalNotConnected">
        <div class="form-group">
          <label class="form-label">OAuth Client ID</label>
          <input type="text" class="form-input" id="gcalClientId" placeholder="xxxx.apps.googleusercontent.com">
          <div style="font-size:10px;color:var(--text3);margin-top:4px;">å¾ Google Cloud Console â†’ APIs â†’ æ†‘è­‰ å–å¾—</div>
        </div>
        <button class="g-signin-btn" onclick="googleSignIn()">
          <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
        </button>
      </div>
      <div id="gcalConnected" style="display:none;">
        <div class="g-user-row">
          <div class="g-user-avatar" id="gcalAvatar">G</div>
          <div class="g-user-info">
            <div class="g-user-name" id="gcalUserName">å·²é€£ç·š</div>
            <div class="g-user-email" id="gcalUserEmail"></div>
          </div>
          <button class="g-signout-btn" onclick="googleSignOut()">ç™»å‡º</button>
        </div>
        <div class="g-sync-status" id="gcalSyncStatus">
          <span style="color:var(--green);">â—</span> å·²é€£ç·š
        </div>
        <button class="settings-btn" onclick="refreshGCalEvents()" style="margin-top:8px;">ğŸ”„ é‡æ–°æ‹‰å–äº‹ä»¶</button>
      </div>
    </div>

    <div class="settings-card">
      <h4>ğŸ”— Make.com Webhook</h4>
      <p>å¯«å…¥åŒæ­¥ â€” æ–°å¢/ç·¨è¼¯/åˆªé™¤è¡Œç¨‹ â†’ Google Calendar</p>
      <div class="form-group">
        <label class="form-label">è¡Œç¨‹åŒæ­¥ Webhook</label>
        <input type="text" class="form-input" id="whCalendar" placeholder="https://hook.us2.make.com/...">
      </div>
      <div class="form-group">
        <label class="form-label">LINE é€šçŸ¥ Webhook</label>
        <input type="text" class="form-input" id="whLine" placeholder="https://hook.us2.make.com/...">
      </div>
      <button class="settings-btn" onclick="saveSettings()" style="background:var(--text);color:var(--bg);border:none;width:100%;">ğŸ’¾ å„²å­˜è¨­å®š</button>
    </div>

    <div class="settings-card">
      <h4>ğŸ”” æ¯æ—¥æé†’</h4>
      <p>é€é LINE æ¨æ’­ç•¶æ—¥æ‘˜è¦</p>
      <div class="form-row" style="margin-bottom:12px;">
        <div class="form-group"><label class="form-label">æé†’æ™‚é–“</label><input type="time" class="form-input" id="reminderTime" value="07:30"></div>
        <div class="form-group"><label class="form-label">ç‹€æ…‹</label><div style="padding-top:8px;"><span class="status-dot" id="lineStatus">â— æœªè¨­å®š</span></div></div>
      </div>
      <button class="settings-btn" onclick="testLine()">ğŸ“¤ æ¸¬è©¦ LINE é€šçŸ¥</button>
    </div>

    <div class="settings-card">
      <h4>ğŸ“Š è³‡æ–™ç®¡ç†</h4>
      <p>åŒ¯å‡ºå‚™ä»½æˆ–æ¸…é™¤è³‡æ–™</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="settings-btn" onclick="exportData()">ğŸ“¥ åŒ¯å‡º</button>
        <button class="settings-btn" onclick="document.getElementById('importFile').click()">ğŸ“¤ åŒ¯å…¥</button>
        <button class="settings-btn danger" onclick="clearAll()">ğŸ—‘ æ¸…é™¤</button>
      </div>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
    </div>
  </div>
</div>

<!-- FAB -->
<button class="fab" id="fabBtn" onclick="fabAction()">+</button>

<!-- Bottom Nav -->
<div class="bottom-nav">
  <button class="nav-btn active" onclick="sw('dashboard',0)"><span class="nav-icon">â—</span>ç¸½è¦½</button>
  <button class="nav-btn" onclick="sw('schedule',1)"><span class="nav-icon">â—·</span>è¡Œç¨‹<span class="badge" id="bSched">0</span></button>
  <button class="nav-btn" onclick="sw('todos',2)"><span class="nav-icon">â˜‘</span>å¾…è¾¦<span class="badge" id="bTodo">0</span></button>
  <button class="nav-btn" onclick="sw('notes',3)"><span class="nav-icon">âœ</span>ç­†è¨˜</button>
  <button class="nav-btn" onclick="sw('settings',4)"><span class="nav-icon">âš™</span>è¨­å®š</button>
</div>

<!-- ===================== MODALS ===================== -->

<!-- Schedule Modal -->
<div class="modal-overlay" id="scheduleModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h3 id="smTitle">æ–°å¢è¡Œç¨‹</h3>
      <button class="modal-close" onclick="closeModal('scheduleModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="smEditId">
      <div class="form-group"><label class="form-label">è¡Œç¨‹åç¨±</label><input type="text" class="form-input" id="smName" placeholder="æœƒè­°ã€çœ‹ç‰™é†«..."></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">æ—¥æœŸ</label><input type="date" class="form-input" id="smDate"></div>
        <div class="form-group"><label class="form-label">åˆ†é¡</label>
          <select class="form-select" id="smCat">
            <option value="work">ğŸ’¼ å·¥ä½œ</option><option value="personal">ğŸ  å€‹äºº</option>
            <option value="meeting">ğŸ‘¥ æœƒè­°</option><option value="health">ğŸ’Š å¥åº·</option>
            <option value="other">ğŸ“Œ å…¶ä»–</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">é–‹å§‹æ™‚é–“</label><input type="time" class="form-input" id="smStart"></div>
        <div class="form-group"><label class="form-label">çµæŸæ™‚é–“</label><input type="time" class="form-input" id="smEnd"></div>
      </div>
      <div class="form-group"><label class="form-label">åœ°é»ï¼ˆé¸å¡«ï¼‰</label><input type="text" class="form-input" id="smLoc" placeholder="è¾¦å…¬å®¤ã€ç·šä¸Š..."></div>
      <div class="form-group"><label class="form-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label><textarea class="form-textarea" id="smNote" placeholder="å‚™è¨»..."></textarea></div>
      <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;color:var(--text2);"><input type="checkbox" id="smSync" checked> åŒæ­¥ Google Calendar</label>
      <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;color:var(--text2);margin-top:8px;"><input type="checkbox" id="smSaveFav"> å„²å­˜ç‚ºå¸¸ç”¨è¡Œç¨‹</label>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="smDeleteBtn" onclick="deleteScheduleFromModal()" style="display:none;background:var(--red-bg);color:var(--red);">åˆªé™¤</button>
      <button class="btn btn-secondary" onclick="closeModal('scheduleModal')">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveSchedule()">å„²å­˜</button>
    </div>
  </div>
</div>

<!-- Todo Modal -->
<div class="modal-overlay" id="todoModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h3 id="tmTitle">æ–°å¢å¾…è¾¦</h3>
      <button class="modal-close" onclick="closeModal('todoModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="tmEditId">
      <div class="form-group"><label class="form-label">å¾…è¾¦å…§å®¹</label><input type="text" class="form-input" id="tmName" placeholder="è¦åšçš„äº‹..."></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">å„ªå…ˆç­‰ç´š</label>
          <select class="form-select" id="tmPri">
            <option value="urgent-important">ğŸ”´ ç·Šæ€¥é‡è¦</option><option value="important">ğŸŸ¡ é‡è¦</option>
            <option value="urgent">ğŸ”µ ç·Šæ€¥</option><option value="normal" selected>ğŸŸ£ ä¸€èˆ¬</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">åˆ°æœŸæ—¥</label><input type="date" class="form-input" id="tmDue"></div>
      </div>
      <div class="form-group"><label class="form-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label><textarea class="form-textarea" id="tmNote" placeholder="å‚™è¨»..."></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('todoModal')">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveTodo()">å„²å­˜</button>
    </div>
  </div>
</div>

<!-- Note Modal -->
<div class="modal-overlay" id="noteModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h3 id="nmTitle">æ–°å¢ç­†è¨˜</h3>
      <button class="modal-close" onclick="closeModal('noteModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="nmEditId">
      <div class="form-group"><label class="form-label">æ¨™é¡Œ</label><input type="text" class="form-input" id="nmName" placeholder="ç­†è¨˜æ¨™é¡Œ..."></div>
      <div class="form-group"><label class="form-label">å…§å®¹</label><textarea class="form-textarea" id="nmContent" placeholder="è¨˜ä¸‹æƒ³æ³•..." style="min-height:120px;"></textarea></div>
      <div class="form-group"><label class="form-label">æ¨™ç±¤ï¼ˆé€—è™Ÿåˆ†éš”ï¼‰</label><input type="text" class="form-input" id="nmTags" placeholder="éˆæ„Ÿ, å·¥ä½œ..."></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('noteModal')">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="saveNote()">å„²å­˜</button>
    </div>
  </div>
</div>

<!-- Quick Apply Favorite Modal (multi-day + time) -->
<div class="modal-overlay" id="favApplyModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h3 id="faTitle">å¿«é€Ÿæ–°å¢</h3>
      <button class="modal-close" onclick="closeModal('favApplyModal')">âœ•</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="faFavId">

      <!-- Fav info preview -->
      <div style="display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--bg2);border-radius:var(--r-sm);margin-bottom:16px;">
        <span id="faIcon" style="font-size:20px;">ğŸ“…</span>
        <div>
          <div id="faName" style="font-size:15px;font-weight:600;"></div>
          <div id="faMeta" style="font-size:11px;color:var(--text3);"></div>
        </div>
      </div>

      <!-- Multi-day calendar picker -->
      <div class="form-label">é¸æ“‡æ—¥æœŸï¼ˆå¯å¤šé¸ï¼‰</div>
      <div style="background:var(--surface);border:1px solid var(--border-light);border-radius:var(--r-sm);padding:10px 8px;margin-bottom:8px;">
        <div class="cal-header" style="margin-bottom:8px;">
          <div class="cal-title" id="faCalTitle" style="font-size:15px;"></div>
          <div class="cal-nav">
            <button class="cal-nav-btn" onclick="faCalNav(-1)" style="width:28px;height:28px;">â—‚</button>
            <button class="cal-nav-btn" onclick="faCalNav(1)" style="width:28px;height:28px;">â–¸</button>
          </div>
        </div>
        <div class="cal-weekdays"><span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span></div>
        <div class="multi-cal-grid" id="faCalDays"></div>
      </div>
      <div class="picked-summary" id="faPickedDays"></div>

      <!-- Time slot grid -->
      <div class="time-slots-label">æ™‚æ®µ</div>
      <div class="time-slots-grid" id="faTimeSlots"></div>

      <!-- Custom time -->
      <div class="time-custom-row">
        <label>è‡ªè¨‚</label>
        <input type="time" id="faCustomStart" placeholder="é–‹å§‹">
        <span style="color:var(--text3);">â€”</span>
        <input type="time" id="faCustomEnd" placeholder="çµæŸ">
      </div>

      <!-- Sync option -->
      <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;color:var(--text2);"><input type="checkbox" id="faSync" checked> åŒæ­¥ Google Calendar</label>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('favApplyModal')">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="applyFavorite()">æ–°å¢ <span id="faDayCount">0</span> ç­†</button>
    </div>
  </div>
</div>

<!-- Manage Favorites Modal -->
<div class="modal-overlay" id="favManageModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h3>ç®¡ç†å¸¸ç”¨è¡Œç¨‹</h3>
      <button class="modal-close" onclick="closeModal('favManageModal')">âœ•</button>
    </div>
    <div class="modal-body" id="favManageList"></div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeModal('favManageModal')" style="flex:1;">å®Œæˆ</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast-container" id="toastBox"></div>

<script>
// =============== DATA LAYER ===============
const SK = { schedules:'pa_s', todos:'pa_t', notes:'pa_n', settings:'pa_set', favorites:'pa_f' };
// In-memory cache to survive localStorage quirks in artifact preview
const _cache = {};
const get = k => {
  try {
    const v = localStorage.getItem(SK[k]);
    if(v) { _cache[k] = JSON.parse(v); return _cache[k]; }
    return _cache[k] || [];
  } catch{ return _cache[k] || []; }
};
const set = (k,v) => {
  _cache[k] = v;
  try { localStorage.setItem(SK[k], JSON.stringify(v)); } catch{}
};
const getSett = () => { try { const v=localStorage.getItem(SK.settings); if(v){_cache.settings=JSON.parse(v);return _cache.settings;} return _cache.settings||{}; } catch{ return _cache.settings||{}; }};
const uid = () => Date.now().toString(36)+Math.random().toString(36).substr(2,5);

// =============== DATE UTILS ===============
let viewDate = new Date();
const fmtDate = d => { const x=new Date(d); return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`; };
const today = () => fmtDate(new Date());
const isOverdue = d => d && new Date(d) < new Date(today());
const DAYS = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
const fmtDateZh = d => { const x=new Date(d); return `${x.getMonth()+1} æœˆ ${x.getDate()} æ—¥ï¼ˆ${DAYS[x.getDay()]}ï¼‰`; };

// =============== TOAST ===============
function toast(msg, type='info') {
  const c = document.getElementById('toastBox');
  const t = document.createElement('div');
  t.className = `toast ${type}`; t.textContent = msg;
  c.appendChild(t);
  setTimeout(()=>t.remove(), 3000);
}

// =============== NAVIGATION ===============
let currentPanel = 'dashboard';
function sw(name, idx) {
  currentPanel = name;
  document.querySelectorAll('.nav-btn').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn')[idx].classList.add('active');
  document.getElementById('p-'+name).classList.add('active');
  window.scrollTo(0,0);
  if(name==='dashboard') renderDashboard();
  if(name==='schedule') { renderSchedule(); fetchGCalMonthEvents(calYear,calMonth).then(()=>renderSchedule()); }
  if(name==='todos') renderTodos();
  if(name==='notes') renderNotes();
  if(name==='settings') loadSettings();
  // FAB visibility
  document.getElementById('fabBtn').style.display = name==='settings'?'none':'flex';
}

// =============== MODAL ===============
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if(e.target===o) o.classList.remove('active'); });
});

// =============== FAB ===============
function fabAction() {
  if(currentPanel==='schedule') openScheduleModal();
  else if(currentPanel==='todos') openTodoModal();
  else if(currentPanel==='notes') openNoteModal();
  else openScheduleModal(); // dashboard default
}

// =============== SCHEDULE ===============
let calMonth = new Date().getMonth();
let calYear = new Date().getFullYear();

const CAT_MAP = {work:'acc-work',personal:'acc-personal',meeting:'acc-meeting',health:'acc-health',other:'acc-other'};
const CAT_CHIP = {work:'cat-work',personal:'cat-personal',meeting:'cat-meeting',health:'cat-health',other:'cat-other'};
const CAT_LABEL = {work:'ğŸ’¼ å·¥ä½œ',personal:'ğŸ  å€‹äºº',meeting:'ğŸ‘¥ æœƒè­°',health:'ğŸ’Š å¥åº·',other:'ğŸ“Œ å…¶ä»–'};
const CAT_ICON = {work:'ğŸ’¼',personal:'ğŸ ',meeting:'ğŸ‘¥',health:'ğŸ’Š',other:'ğŸ“Œ'};

const TIME_SLOTS = [
  {label:'06:00',s:'06:00',e:'07:00'},{label:'07:00',s:'07:00',e:'08:00'},
  {label:'08:00',s:'08:00',e:'09:00'},{label:'09:00',s:'09:00',e:'10:00'},
  {label:'10:00',s:'10:00',e:'11:00'},{label:'11:00',s:'11:00',e:'12:00'},
  {label:'12:00',s:'12:00',e:'13:00'},{label:'13:00',s:'13:00',e:'14:00'},
  {label:'14:00',s:'14:00',e:'15:00'},{label:'15:00',s:'15:00',e:'16:00'},
  {label:'16:00',s:'16:00',e:'17:00'},{label:'17:00',s:'17:00',e:'18:00'},
  {label:'18:00',s:'18:00',e:'19:00'},{label:'19:00',s:'19:00',e:'20:00'},
  {label:'20:00',s:'20:00',e:'21:00'},{label:'21:00',s:'21:00',e:'22:00'},
];

// --- Calendar rendering ---
function calNav(n) { calMonth+=n; if(calMonth>11){calMonth=0;calYear++;} if(calMonth<0){calMonth=11;calYear--;} renderCalendar(); fetchGCalMonthEvents(calYear, calMonth).then(()=>renderCalendar()); }
function calGoToday() { const n=new Date(); calMonth=n.getMonth(); calYear=n.getFullYear(); viewDate=new Date(); renderCalendar(); renderDaySchedule(); fetchGCalMonthEvents(calYear, calMonth).then(()=>{renderCalendar();renderDaySchedule();}); }

function renderCalendar() {
  document.getElementById('calTitle').textContent = `${calYear} å¹´ ${calMonth+1} æœˆ`;
  const first = new Date(calYear, calMonth, 1);
  const lastDay = new Date(calYear, calMonth+1, 0).getDate();
  const startDow = first.getDay();
  const todayStr = today();
  const selectedStr = fmtDate(viewDate);
  const scheds = get('schedules');
  const eventDates = new Set(scheds.map(s=>s.date));
  // Merge Google Calendar event dates
  const gcalDates = getGCalEventDates();
  gcalDates.forEach(d => eventDates.add(d));

  let html = '';
  // Previous month fill
  const prevLast = new Date(calYear, calMonth, 0).getDate();
  for(let i=startDow-1; i>=0; i--) {
    html += `<button class="cal-day other-month">${prevLast-i}</button>`;
  }
  // Current month
  for(let d=1; d<=lastDay; d++) {
    const ds = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const cls = [];
    if(ds===todayStr) cls.push('today');
    if(ds===selectedStr) cls.push('selected');
    if(eventDates.has(ds)) cls.push('has-event');
    html += `<button class="cal-day ${cls.join(' ')}" onclick="selectCalDay('${ds}')">${d}</button>`;
  }
  // Next month fill
  const total = startDow + lastDay;
  const fill = total <= 35 ? 35 - total : 42 - total;
  for(let i=1; i<=fill; i++) {
    html += `<button class="cal-day other-month">${i}</button>`;
  }
  document.getElementById('calDays').innerHTML = html;
}

function selectCalDay(ds) {
  viewDate = new Date(ds + 'T00:00:00');
  renderCalendar();
  renderDaySchedule();
}

function renderDaySchedule() {
  const ds = fmtDate(viewDate);
  document.getElementById('dayListTitle').innerHTML = `<span class="line"></span> ${fmtDateZh(viewDate)}`;

  // Local events
  const localItems = get('schedules').filter(s=>s.date===ds);
  // Google Calendar events (exclude those already synced from this app)
  const gcalItems = getGCalEventsForDate(ds).filter(g => {
    // Skip if a local event has the same calendarEventId
    return !localItems.some(l => l.calendarEventId && g.gcalId && l.calendarEventId === g.gcalId);
  });

  // Merge and sort
  const allItems = [
    ...localItems.map(s => ({...s, isGcal: false})),
    ...gcalItems.map(g => ({...g, isGcal: true})),
  ].sort((a,b) => (a.startTime||'99').localeCompare(b.startTime||'99'));

  const el = document.getElementById('scheduleList');
  if(!allItems.length) {
    el.innerHTML=`<div class="empty"><div class="icon">ğŸ“…</div><div class="msg">é€™å¤©æ²’æœ‰è¡Œç¨‹</div><button class="btn btn-primary" onclick="openScheduleModal()" style="margin-top:12px;display:inline-block;flex:unset;padding:10px 24px;">ï¼‹ æ–°å¢è¡Œç¨‹</button></div>`;
    return;
  }
  el.innerHTML = allItems.map(s => {
    if(s.isGcal) {
      // Google Calendar event (read-only, open in new tab)
      const accentCls = s.colorId ? `gcal-c${s.colorId}` : 'gcal-accent';
      return `
      <div class="card-item gcal-item" ${s.htmlLink?`onclick="window.open('${s.htmlLink}','_blank')"`:''}">
        <div class="sched-accent ${accentCls}"></div>
        <div class="card-body">
          <div class="card-title">${esc(s.title)}</div>
          <div class="card-meta">
            <span class="gcal-badge"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/></svg> Google</span>
            ${s.location?`<span>ğŸ“ ${esc(s.location)}</span>`:''}
          </div>
        </div>
        <div class="time-block">
          <div class="time-main">${s.startTime||'å…¨å¤©'}</div>
          ${s.endTime?`<div class="time-end">${s.endTime}</div>`:''}
        </div>
      </div>`;
    } else {
      // Local event
      return `
      <div class="card-item" onclick="openScheduleModal('${s.id}')">
        <div class="sched-accent ${CAT_MAP[s.category]||'acc-other'}"></div>
        <div class="card-body">
          <div class="card-title">${esc(s.title)}</div>
          <div class="card-meta">
            <span class="sched-cat ${CAT_CHIP[s.category]||'cat-other'}">${CAT_LABEL[s.category]||'ğŸ“Œ å…¶ä»–'}</span>
            ${s.location?`<span>ğŸ“ ${esc(s.location)}</span>`:''}
            ${s.syncCal?'<span style="color:var(--green)">â— å·²åŒæ­¥</span>':''}
          </div>
        </div>
        <div class="time-block">
          <div class="time-main">${s.startTime||'å…¨å¤©'}</div>
          ${s.endTime?`<div class="time-end">${s.endTime}</div>`:''}
        </div>
        <span class="chevron">â€º</span>
      </div>`;
    }
  }).join('');
}

function renderSchedule() {
  try { renderCalendar(); } catch(e) { console.error('renderCalendar:', e); }
  try { renderFavScroll(); } catch(e) { console.error('renderFavScroll:', e); }
  try { renderDaySchedule(); } catch(e) { console.error('renderDaySchedule:', e); }
}

// --- Schedule Modal ---
function openScheduleModal(editId=null) {
  document.getElementById('smEditId').value = editId||'';
  document.getElementById('smTitle').textContent = editId?'ç·¨è¼¯è¡Œç¨‹':'æ–°å¢è¡Œç¨‹';
  document.getElementById('smDeleteBtn').style.display = editId?'block':'none';
  document.getElementById('smSaveFav').checked = false;
  if(editId) {
    const s = get('schedules').find(x=>x.id===editId);
    if(s) {
      document.getElementById('smName').value=s.title;
      document.getElementById('smDate').value=s.date;
      document.getElementById('smStart').value=s.startTime||'';
      document.getElementById('smEnd').value=s.endTime||'';
      document.getElementById('smCat').value=s.category||'other';
      document.getElementById('smLoc').value=s.location||'';
      document.getElementById('smNote').value=s.note||'';
      document.getElementById('smSync').checked=s.syncCal!==false;
    }
  } else {
    ['smName','smStart','smEnd','smLoc','smNote'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('smDate').value=fmtDate(viewDate);
    document.getElementById('smCat').value='other';
    document.getElementById('smSync').checked=true;
  }
  openModal('scheduleModal');
}

async function saveSchedule() {
  const title=document.getElementById('smName').value.trim();
  if(!title) { toast('è«‹è¼¸å…¥è¡Œç¨‹åç¨±','error'); return; }
  const editId=document.getElementById('smEditId').value;
  const list=get('schedules');
  const entry = {
    id: editId||uid(), title,
    date: document.getElementById('smDate').value,
    startTime: document.getElementById('smStart').value,
    endTime: document.getElementById('smEnd').value,
    category: document.getElementById('smCat').value,
    location: document.getElementById('smLoc').value.trim(),
    note: document.getElementById('smNote').value.trim(),
    syncCal: document.getElementById('smSync').checked,
    createdAt: editId?(list.find(x=>x.id===editId)?.createdAt||new Date().toISOString()):new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    calendarEventId: editId?(list.find(x=>x.id===editId)?.calendarEventId||null):null,
  };
  if(editId) { const i=list.findIndex(x=>x.id===editId); if(i>=0) list[i]=entry; }
  else list.push(entry);
  set('schedules', list);

  // Save as favorite if checked
  if(document.getElementById('smSaveFav').checked) {
    const favs = get('favorites');
    favs.push({
      id: uid(), title, category: entry.category,
      startTime: entry.startTime, endTime: entry.endTime,
      location: entry.location, note: entry.note, syncCal: entry.syncCal,
      createdAt: new Date().toISOString()
    });
    set('favorites', favs);
    toast('è¡Œç¨‹å·²æ–°å¢ï¼Œä¸¦å„²å­˜ç‚ºå¸¸ç”¨','success');
  } else {
    toast(editId?'è¡Œç¨‹å·²æ›´æ–°':'è¡Œç¨‹å·²æ–°å¢','success');
  }

  closeModal('scheduleModal');
  renderSchedule(); updateBadges();
  if(entry.syncCal) syncCal(editId?'update':'create', entry);
}

function deleteScheduleFromModal() {
  const editId = document.getElementById('smEditId').value;
  if(!editId) return;
  deleteSchedule(editId);
  closeModal('scheduleModal');
}

function deleteSchedule(id) {
  if(!confirm('åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ')) return;
  const list=get('schedules'); const item=list.find(x=>x.id===id);
  set('schedules', list.filter(x=>x.id!==id));
  toast('è¡Œç¨‹å·²åˆªé™¤','success');
  renderSchedule(); updateBadges();
  if(item?.calendarEventId) syncCal('delete', item);
}

// --- Favorites ---
function renderFavScroll() {
  const favs = get('favorites');
  const el = document.getElementById('favScroll');
  let html = favs.map(f => `
    <button class="fav-chip" onclick="openFavApply('${f.id}')">
      <span class="fav-icon">${CAT_ICON[f.category]||'ğŸ“Œ'}</span>
      <span>${esc(f.title)}</span>
      ${f.startTime?`<span class="fav-time">${f.startTime}</span>`:''}
    </button>`).join('');
  html += `<button class="fav-chip fav-chip-add" onclick="openScheduleModal()">ï¼‹ æ–°å¢</button>`;
  el.innerHTML = html;
}

function openFavManage() {
  const favs = get('favorites');
  const el = document.getElementById('favManageList');
  if(!favs.length) {
    el.innerHTML = '<div class="empty"><div class="icon">â­</div><div class="msg">é‚„æ²’æœ‰å¸¸ç”¨è¡Œç¨‹<br><small style="color:var(--text3)">æ–°å¢è¡Œç¨‹æ™‚å‹¾é¸ã€Œå„²å­˜ç‚ºå¸¸ç”¨è¡Œç¨‹ã€å³å¯</small></div></div>';
  } else {
    el.innerHTML = favs.map(f => `
      <div class="fav-manage-item">
        <div style="font-size:20px;">${CAT_ICON[f.category]||'ğŸ“Œ'}</div>
        <div class="fav-manage-body">
          <div class="fav-manage-title">${esc(f.title)}</div>
          <div class="fav-manage-meta">${CAT_LABEL[f.category]||'å…¶ä»–'} ${f.startTime?'Â· '+f.startTime+'-'+(f.endTime||''):''} ${f.location?'Â· ğŸ“'+esc(f.location):''}</div>
        </div>
        <button class="fav-manage-del" onclick="deleteFav('${f.id}')">âœ•</button>
      </div>`).join('');
  }
  openModal('favManageModal');
}

function deleteFav(id) {
  set('favorites', get('favorites').filter(x=>x.id!==id));
  openFavManage(); renderFavScroll();
  toast('å·²åˆªé™¤å¸¸ç”¨è¡Œç¨‹','success');
}

// --- Quick Apply Favorite (multi-day + time) ---
let faPickedDays = [];
let faPickedSlot = null;
let faCalMonth, faCalYear;

function openFavApply(favId) {
  const fav = get('favorites').find(x=>x.id===favId);
  if(!fav) return;
  document.getElementById('faFavId').value = favId;
  document.getElementById('faName').textContent = fav.title;
  document.getElementById('faIcon').textContent = CAT_ICON[fav.category]||'ğŸ“Œ';
  document.getElementById('faMeta').textContent = `${CAT_LABEL[fav.category]||'å…¶ä»–'} ${fav.startTime?'Â· '+fav.startTime+'-'+(fav.endTime||''):''} ${fav.location?'Â· ğŸ“'+fav.location:''}`;

  // Init state
  faPickedDays = [fmtDate(viewDate)];
  faPickedSlot = fav.startTime ? { s: fav.startTime, e: fav.endTime||'' } : null;
  faCalMonth = viewDate.getMonth();
  faCalYear = viewDate.getFullYear();

  // Set custom time to fav defaults
  document.getElementById('faCustomStart').value = fav.startTime||'';
  document.getElementById('faCustomEnd').value = fav.endTime||'';
  document.getElementById('faSync').checked = fav.syncCal!==false;

  renderFaCal();
  renderFaPickedDays();
  renderFaTimeSlots();
  openModal('favApplyModal');
}

function faCalNav(n) { faCalMonth+=n; if(faCalMonth>11){faCalMonth=0;faCalYear++;} if(faCalMonth<0){faCalMonth=11;faCalYear--;} renderFaCal(); }

function renderFaCal() {
  document.getElementById('faCalTitle').textContent = `${faCalYear} å¹´ ${faCalMonth+1} æœˆ`;
  const first = new Date(faCalYear, faCalMonth, 1);
  const lastDay = new Date(faCalYear, faCalMonth+1, 0).getDate();
  const startDow = first.getDay();
  const todayStr = today();
  let html = '';
  const prevLast = new Date(faCalYear, faCalMonth, 0).getDate();
  for(let i=startDow-1;i>=0;i--) html+=`<button class="multi-cal-day other-month">${prevLast-i}</button>`;
  for(let d=1;d<=lastDay;d++) {
    const ds = `${faCalYear}-${String(faCalMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const cls = [];
    if(ds===todayStr) cls.push('today');
    if(faPickedDays.includes(ds)) cls.push('picked');
    html+=`<button class="multi-cal-day ${cls.join(' ')}" onclick="toggleFaDay('${ds}')">${d}</button>`;
  }
  const total=startDow+lastDay; const fill=total<=35?35-total:42-total;
  for(let i=1;i<=fill;i++) html+=`<button class="multi-cal-day other-month">${i}</button>`;
  document.getElementById('faCalDays').innerHTML = html;
}

function toggleFaDay(ds) {
  const idx = faPickedDays.indexOf(ds);
  if(idx>=0) faPickedDays.splice(idx,1);
  else faPickedDays.push(ds);
  faPickedDays.sort();
  renderFaCal();
  renderFaPickedDays();
}

function removeFaDay(ds) {
  faPickedDays = faPickedDays.filter(d=>d!==ds);
  renderFaCal();
  renderFaPickedDays();
}

function renderFaPickedDays() {
  const el = document.getElementById('faPickedDays');
  if(!faPickedDays.length) { el.innerHTML='<span style="font-size:12px;color:var(--text3);">è«‹é¸æ“‡è‡³å°‘ä¸€å¤©</span>'; }
  else {
    el.innerHTML = faPickedDays.map(ds => {
      const x = new Date(ds+'T00:00:00');
      return `<span class="picked-tag">${x.getMonth()+1}/${x.getDate()}ï¼ˆ${DAYS[x.getDay()]}ï¼‰<span class="remove-day" onclick="removeFaDay('${ds}')">âœ•</span></span>`;
    }).join('');
  }
  document.getElementById('faDayCount').textContent = faPickedDays.length;
}

function renderFaTimeSlots() {
  const el = document.getElementById('faTimeSlots');
  el.innerHTML = TIME_SLOTS.map((t,i) => {
    const picked = faPickedSlot && faPickedSlot.s===t.s;
    return `<button class="time-slot ${picked?'picked':''}" onclick="pickTimeSlot(${i})">${t.label}</button>`;
  }).join('');
}

function pickTimeSlot(idx) {
  const t = TIME_SLOTS[idx];
  if(faPickedSlot && faPickedSlot.s===t.s) { faPickedSlot=null; }
  else { faPickedSlot = { s:t.s, e:t.e }; }
  document.getElementById('faCustomStart').value = faPickedSlot?faPickedSlot.s:'';
  document.getElementById('faCustomEnd').value = faPickedSlot?faPickedSlot.e:'';
  renderFaTimeSlots();
}

// Listen for custom time input changes
document.addEventListener('DOMContentLoaded', () => {
  ['faCustomStart','faCustomEnd'].forEach(id => {
    document.getElementById(id)?.addEventListener('change', () => {
      const s = document.getElementById('faCustomStart').value;
      const e = document.getElementById('faCustomEnd').value;
      faPickedSlot = s ? { s, e } : null;
      renderFaTimeSlots(); // deselect grid if custom
    });
  });
});

async function applyFavorite() {
  if(!faPickedDays.length) { toast('è«‹é¸æ“‡è‡³å°‘ä¸€å¤©','error'); return; }
  const favId = document.getElementById('faFavId').value;
  const favs = get('favorites');
  const fav = favs.find(x=>x.id===favId);
  if(!fav) { toast('æ‰¾ä¸åˆ°å¸¸ç”¨è¡Œç¨‹','error'); return; }

  const startT = document.getElementById('faCustomStart').value || '';
  const endT = document.getElementById('faCustomEnd').value || '';
  const doSync = document.getElementById('faSync').checked;

  const list = get('schedules');
  const newEntries = [];
  faPickedDays.forEach(ds => {
    const entry = {
      id: uid(), title: fav.title, date: ds,
      startTime: startT, endTime: endT,
      category: fav.category, location: fav.location||'',
      note: fav.note||'', syncCal: doSync,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      calendarEventId: null,
    };
    list.push(entry);
    newEntries.push(entry);
  });
  set('schedules', list);
  closeModal('favApplyModal');
  toast(`å·²æ–°å¢ ${newEntries.length} ç­†è¡Œç¨‹`, 'success');

  // Explicitly re-render all parts
  try { renderCalendar(); } catch(e) {}
  try { renderFavScroll(); } catch(e) {}
  try { renderDaySchedule(); } catch(e) {}
  updateBadges();

  // Sync each to calendar
  if(doSync) {
    for(const entry of newEntries) {
      await syncCal('create', entry);
    }
  }
}

// =============== TODOS ===============
let todoFilter = 'all';
const PRI_ORDER = {'urgent-important':0,'important':1,'urgent':2,'normal':3};
const PRI_LABEL = {'urgent-important':'ç·Šæ€¥é‡è¦','important':'é‡è¦','urgent':'ç·Šæ€¥','normal':'ä¸€èˆ¬'};
const PRI_CLASS = {'urgent-important':'pri-ui','important':'pri-i','urgent':'pri-u','normal':'pri-n'};

function setFilter(f, el) {
  todoFilter=f;
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('on'));
  el?.classList.add('on');
  renderTodos();
}

function quickAdd() {
  const inp=document.getElementById('quickInput');
  const t=inp.value.trim(); if(!t) return;
  const list=get('todos');
  list.push({id:uid(),title:t,priority:'normal',dueDate:'',note:'',completed:false,createdAt:new Date().toISOString()});
  set('todos',list); inp.value='';
  toast('å¾…è¾¦å·²æ–°å¢','success');
  renderTodos(); updateBadges();
}

function openTodoModal(editId=null) {
  document.getElementById('tmEditId').value=editId||'';
  document.getElementById('tmTitle').textContent=editId?'ç·¨è¼¯å¾…è¾¦':'æ–°å¢å¾…è¾¦';
  if(editId) {
    const t=get('todos').find(x=>x.id===editId);
    if(t) { document.getElementById('tmName').value=t.title; document.getElementById('tmPri').value=t.priority; document.getElementById('tmDue').value=t.dueDate||''; document.getElementById('tmNote').value=t.note||''; }
  } else {
    ['tmName','tmDue','tmNote'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('tmPri').value='normal';
  }
  openModal('todoModal');
}

function saveTodo() {
  const title=document.getElementById('tmName').value.trim();
  if(!title) { toast('è«‹è¼¸å…¥å¾…è¾¦å…§å®¹','error'); return; }
  const editId=document.getElementById('tmEditId').value;
  const list=get('todos');
  const entry = {
    id: editId||uid(), title,
    priority: document.getElementById('tmPri').value,
    dueDate: document.getElementById('tmDue').value,
    note: document.getElementById('tmNote').value.trim(),
    completed: editId?(list.find(x=>x.id===editId)?.completed||false):false,
    completedAt: editId?(list.find(x=>x.id===editId)?.completedAt||null):null,
    createdAt: editId?(list.find(x=>x.id===editId)?.createdAt||new Date().toISOString()):new Date().toISOString(),
  };
  if(editId) { const i=list.findIndex(x=>x.id===editId); if(i>=0) list[i]=entry; }
  else list.push(entry);
  set('todos',list);
  closeModal('todoModal');
  toast(editId?'å¾…è¾¦å·²æ›´æ–°':'å¾…è¾¦å·²æ–°å¢','success');
  renderTodos(); updateBadges();
}

function toggleTodo(id, e) {
  e?.stopPropagation();
  const list=get('todos');
  const t=list.find(x=>x.id===id);
  if(t) { t.completed=!t.completed; t.completedAt=t.completed?new Date().toISOString():null; }
  set('todos',list); renderTodos(); updateBadges();
}

function deleteTodo(id) {
  if(!confirm('åˆªé™¤æ­¤å¾…è¾¦ï¼Ÿ')) return;
  set('todos', get('todos').filter(x=>x.id!==id));
  toast('å·²åˆªé™¤','success'); renderTodos(); updateBadges();
}

function renderTodos() {
  let list=get('todos');
  if(todoFilter==='completed') list=list.filter(t=>t.completed);
  else if(todoFilter!=='all') list=list.filter(t=>!t.completed&&t.priority===todoFilter);
  list.sort((a,b)=>{
    if(a.completed!==b.completed) return a.completed?1:-1;
    const pa=PRI_ORDER[a.priority]??3, pb=PRI_ORDER[b.priority]??3;
    if(pa!==pb) return pa-pb;
    if(a.dueDate&&b.dueDate) return a.dueDate.localeCompare(b.dueDate);
    return a.dueDate?-1:b.dueDate?1:0;
  });
  const el=document.getElementById('todoList');
  if(!list.length) { el.innerHTML='<div class="empty"><div class="icon">â˜‘</div><div class="msg">æ²’æœ‰å¾…è¾¦äº‹é …</div></div>'; return; }
  el.innerHTML = list.map(t=>{
    const od=!t.completed&&isOverdue(t.dueDate);
    return `
    <div class="card-item ${t.completed?'done':''}" onclick="openTodoModal('${t.id}')">
      <div class="todo-check" onclick="toggleTodo('${t.id}',event)">${t.completed?'âœ“':''}</div>
      <div class="card-body">
        <div class="card-title">${esc(t.title)}</div>
        <div class="card-meta">
          <span class="pri-tag ${PRI_CLASS[t.priority]}">${PRI_LABEL[t.priority]}</span>
          ${t.dueDate?`<span class="${od?'overdue':''}">${od?'âš  å·²éæœŸ ':'ğŸ“… '}${t.dueDate}</span>`:''}
          ${t.note?'<span>ğŸ“</span>':''}
        </div>
      </div>
      <span class="chevron">â€º</span>
    </div>`;
  }).join('');
}

// =============== NOTES ===============
function openNoteModal(editId=null) {
  document.getElementById('nmEditId').value=editId||'';
  document.getElementById('nmTitle').textContent=editId?'ç·¨è¼¯ç­†è¨˜':'æ–°å¢ç­†è¨˜';
  if(editId) {
    const n=get('notes').find(x=>x.id===editId);
    if(n) { document.getElementById('nmName').value=n.title; document.getElementById('nmContent').value=n.content; document.getElementById('nmTags').value=(n.tags||[]).join(', '); }
  } else { ['nmName','nmContent','nmTags'].forEach(id=>document.getElementById(id).value=''); }
  openModal('noteModal');
}

function saveNote() {
  const title=document.getElementById('nmName').value.trim();
  const content=document.getElementById('nmContent').value.trim();
  if(!title&&!content) { toast('è«‹è¼¸å…¥å…§å®¹','error'); return; }
  const editId=document.getElementById('nmEditId').value;
  const list=get('notes');
  const tags=document.getElementById('nmTags').value.split(',').map(t=>t.trim()).filter(Boolean);
  const entry = {
    id: editId||uid(), title:title||'ç„¡æ¨™é¡Œ', content, tags,
    createdAt: editId?(list.find(x=>x.id===editId)?.createdAt||new Date().toISOString()):new Date().toISOString(),
    updatedAt: new Date().toISOString(),
  };
  if(editId) { const i=list.findIndex(x=>x.id===editId); if(i>=0) list[i]=entry; }
  else list.push(entry);
  set('notes',list);
  closeModal('noteModal');
  toast(editId?'ç­†è¨˜å·²æ›´æ–°':'ç­†è¨˜å·²æ–°å¢','success');
  renderNotes();
}

function deleteNote(id) {
  if(!confirm('åˆªé™¤æ­¤ç­†è¨˜ï¼Ÿ')) return;
  set('notes', get('notes').filter(x=>x.id!==id));
  toast('å·²åˆªé™¤','success'); renderNotes();
}

function renderNotes() {
  const list=get('notes').sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));
  const el=document.getElementById('notesList');
  if(!list.length) { el.innerHTML='<div class="empty" style="grid-column:1/-1;"><div class="icon">âœ</div><div class="msg">é‚„æ²’æœ‰ç­†è¨˜</div></div>'; return; }
  el.innerHTML = list.map(n=>`
    <div class="note-card" onclick="openNoteModal('${n.id}')">
      <h4>${esc(n.title)}</h4>
      <p>${esc(n.content)}</p>
      ${n.tags?.length?`<div class="note-tags">${n.tags.map(t=>`<span class="note-tag">${esc(t)}</span>`).join('')}</div>`:''}
    </div>`).join('');
}

// =============== DASHBOARD ===============
function renderDashboard() {
  const td=today();
  const scheds=get('schedules');
  const todos=get('todos');
  const notes=get('notes');

  const todayS=scheds.filter(s=>s.date===td);
  // Merge Google Calendar events for today
  const gcalToday = getGCalEventsForDate(td).filter(g => !todayS.some(l=>l.calendarEventId && g.gcalId && l.calendarEventId===g.gcalId));
  const allTodayS = [...todayS.map(s=>({...s,isGcal:false})), ...gcalToday.map(g=>({...g,isGcal:true}))].sort((a,b)=>(a.startTime||'99').localeCompare(b.startTime||'99'));

  const pending=todos.filter(t=>!t.completed);
  const doneToday=todos.filter(t=>t.completed&&t.completedAt&&fmtDate(t.completedAt)===td);
  const overdue=todos.filter(t=>!t.completed&&isOverdue(t.dueDate));

  document.getElementById('statEvents').textContent=allTodayS.length;
  document.getElementById('statTodos').textContent=pending.length;
  document.getElementById('statDone').textContent=doneToday.length;
  document.getElementById('statOverdue').textContent=overdue.length;

  // Greeting
  const h=new Date().getHours();
  document.getElementById('greetingText').textContent = h<12?'Good Morning â˜€':h<18?'Good Afternoon ğŸŒ¤':'Good Evening ğŸŒ™';

  // Schedule preview
  const se=document.getElementById('dashSchedule');
  if(!allTodayS.length) { se.innerHTML='<div style="padding:16px;text-align:center;color:var(--text3);font-size:13px;">ä»Šå¤©æ²’æœ‰è¡Œç¨‹ ğŸ‰</div>'; }
  else { se.innerHTML = allTodayS.slice(0,5).map(s=>{
    if(s.isGcal) return `
    <div class="card-item gcal-item" onclick="sw('schedule',1)">
      <div class="sched-accent ${s.colorId?'gcal-c'+s.colorId:'gcal-accent'}"></div>
      <div class="card-body"><div class="card-title">${esc(s.title)}</div><div class="card-meta"><span class="gcal-badge">G Google</span>${s.location?`<span>ğŸ“ ${esc(s.location)}</span>`:''}</div></div>
      <div class="time-block"><div class="time-main">${s.startTime||'å…¨å¤©'}</div>${s.endTime?`<div class="time-end">${s.endTime}</div>`:''}</div>
    </div>`;
    return `
    <div class="card-item" onclick="sw('schedule',1)">
      <div class="sched-accent ${CAT_MAP[s.category]||'acc-other'}"></div>
      <div class="card-body"><div class="card-title">${esc(s.title)}</div><div class="card-meta"><span class="sched-cat ${CAT_CHIP[s.category]||'cat-other'}">${CAT_LABEL[s.category]||'å…¶ä»–'}</span>${s.location?`<span>ğŸ“ ${esc(s.location)}</span>`:''}</div></div>
      <div class="time-block"><div class="time-main">${s.startTime||'å…¨å¤©'}</div>${s.endTime?`<div class="time-end">${s.endTime}</div>`:''}</div>
    </div>`;
  }).join(''); }

  // Urgent todos
  const te=document.getElementById('dashTodos');
  const urgent=pending.sort((a,b)=>(PRI_ORDER[a.priority]??3)-(PRI_ORDER[b.priority]??3)).slice(0,4);
  if(!urgent.length) { te.innerHTML='<div style="padding:16px;text-align:center;color:var(--text3);font-size:13px;">æ²’æœ‰å¾…è¾¦ âœ¨</div>'; }
  else { te.innerHTML = urgent.map(t=>{
    const od=isOverdue(t.dueDate);
    return `
    <div class="card-item" onclick="sw('todos',2)">
      <div class="todo-check" onclick="toggleTodo('${t.id}',event)"></div>
      <div class="card-body"><div class="card-title">${esc(t.title)}</div><div class="card-meta"><span class="pri-tag ${PRI_CLASS[t.priority]}">${PRI_LABEL[t.priority]}</span>${t.dueDate?`<span class="${od?'overdue':''}">${od?'âš  å·²éæœŸ':t.dueDate}</span>`:''}</div></div>
    </div>`;
  }).join(''); }

  // Notes scroll
  const ne=document.getElementById('dashNotes');
  const recentN=notes.sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt)).slice(0,5);
  if(!recentN.length) { ne.innerHTML='<div style="padding:16px;color:var(--text3);font-size:13px;">é‚„æ²’æœ‰ç­†è¨˜</div>'; }
  else { ne.innerHTML = recentN.map(n=>`
    <div class="note-card" onclick="sw('notes',3)">
      <h4>${esc(n.title)}</h4>
      <p>${esc(n.content)}</p>
      ${n.tags?.length?`<div class="note-tags">${n.tags.slice(0,2).map(t=>`<span class="note-tag">${esc(t)}</span>`).join('')}</div>`:''}
    </div>`).join(''); }
}

// =============== SETTINGS ===============
function loadSettings() {
  const s=getSett();
  document.getElementById('whCalendar').value=s.whCalendar||'';
  document.getElementById('whLine').value=s.whLine||'';
  document.getElementById('gcalClientId').value=s.gcalClientId||'';
  document.getElementById('reminderTime').value=s.reminderTime||'07:30';
  const st=document.getElementById('lineStatus');
  if(s.whLine) { st.className='status-dot status-on'; st.textContent='â— å·²é€£ç·š'; }
  else { st.className='status-dot status-off'; st.textContent='â— æœªè¨­å®š'; }
  // Google Calendar connection state
  updateGCalUI();
}
function saveSettings() {
  const prev = getSett();
  const s = {
    ...prev,
    whCalendar:document.getElementById('whCalendar').value.trim(),
    whLine:document.getElementById('whLine').value.trim(),
    gcalClientId:document.getElementById('gcalClientId').value.trim(),
    reminderTime:document.getElementById('reminderTime').value,
  };
  _cache.settings = s;
  try { localStorage.setItem(SK.settings, JSON.stringify(s)); } catch{}
  toast('è¨­å®šå·²å„²å­˜','success'); loadSettings();
}

// =============== GOOGLE CALENDAR API ===============
let gcalToken = null;       // OAuth2 access token (in memory only)
let gcalUserInfo = null;    // { name, email }
let gcalEventsCache = {};   // { 'YYYY-MM': [events] }
let gcalTokenClient = null; // Google token client instance
let gcalLoading = false;

function updateGCalUI() {
  const connected = !!gcalToken;
  document.getElementById('gcalNotConnected').style.display = connected ? 'none' : 'block';
  document.getElementById('gcalConnected').style.display = connected ? 'block' : 'none';
  if(connected && gcalUserInfo) {
    document.getElementById('gcalUserName').textContent = gcalUserInfo.name || 'å·²é€£ç·š';
    document.getElementById('gcalUserEmail').textContent = gcalUserInfo.email || '';
    document.getElementById('gcalAvatar').textContent = (gcalUserInfo.name||'G')[0].toUpperCase();
  }
}

function googleSignIn() {
  const clientId = document.getElementById('gcalClientId').value.trim();
  if(!clientId) { toast('è«‹å…ˆå¡«å…¥ OAuth Client ID','error'); return; }
  // Save client ID
  const s = getSett();
  s.gcalClientId = clientId;
  _cache.settings = s;
  try { localStorage.setItem(SK.settings, JSON.stringify(s)); } catch{}

  if(typeof google === 'undefined' || !google.accounts) {
    toast('Google API è¼‰å…¥ä¸­ï¼Œè«‹ç¨å¾Œé‡è©¦','error');
    return;
  }

  try {
    gcalTokenClient = google.accounts.oauth2.initTokenClient({
      client_id: clientId,
      scope: 'https://www.googleapis.com/auth/calendar.readonly https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email',
      callback: handleGoogleTokenResponse,
    });
    gcalTokenClient.requestAccessToken();
  } catch(e) {
    toast('Google ç™»å…¥åˆå§‹åŒ–å¤±æ•—: ' + e.message, 'error');
  }
}

async function handleGoogleTokenResponse(resp) {
  if(resp.error) {
    toast('Google æˆæ¬Šå¤±æ•—: ' + resp.error, 'error');
    return;
  }
  gcalToken = resp.access_token;

  // Fetch user info
  try {
    const r = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
      headers: { 'Authorization': 'Bearer ' + gcalToken }
    });
    if(r.ok) gcalUserInfo = await r.json();
  } catch{}

  updateGCalUI();
  toast('Google Calendar å·²é€£ç·š','success');

  // Fetch events for current calendar view
  await fetchGCalMonthEvents(calYear, calMonth);
  renderSchedule();
  renderDashboard();
}

function googleSignOut() {
  if(gcalToken && typeof google !== 'undefined') {
    try { google.accounts.oauth2.revoke(gcalToken); } catch{}
  }
  gcalToken = null;
  gcalUserInfo = null;
  gcalEventsCache = {};
  updateGCalUI();
  renderSchedule();
  renderDashboard();
  toast('å·²ç™»å‡º Google','success');
}

async function fetchGCalMonthEvents(year, month) {
  if(!gcalToken) return;
  const key = `${year}-${String(month+1).padStart(2,'0')}`;
  // Skip if already cached
  if(gcalEventsCache[key]) return;

  const timeMin = new Date(year, month, 1).toISOString();
  const timeMax = new Date(year, month+1, 0, 23, 59, 59).toISOString();

  gcalLoading = true;
  const statusEl = document.getElementById('gcalSyncStatus');
  if(statusEl) statusEl.innerHTML = '<div class="spinner"></div> åŒæ­¥ä¸­...';

  try {
    const url = `https://www.googleapis.com/calendar/v3/calendars/primary/events?` +
      `timeMin=${encodeURIComponent(timeMin)}&timeMax=${encodeURIComponent(timeMax)}` +
      `&singleEvents=true&orderBy=startTime&maxResults=250`;
    const r = await fetch(url, {
      headers: { 'Authorization': 'Bearer ' + gcalToken }
    });
    if(r.status === 401) {
      // Token expired
      gcalToken = null;
      updateGCalUI();
      toast('Google æˆæ¬Šå·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥','error');
      return;
    }
    if(!r.ok) throw new Error('API error ' + r.status);
    const data = await r.json();

    // Parse events
    const events = (data.items || []).map(ev => {
      const start = ev.start?.dateTime || ev.start?.date || '';
      const end = ev.end?.dateTime || ev.end?.date || '';
      const isAllDay = !ev.start?.dateTime;
      const startDate = start.slice(0, 10);
      const startTime = isAllDay ? '' : start.slice(11, 16);
      const endTime = isAllDay ? '' : end.slice(11, 16);
      return {
        id: 'gcal_' + ev.id,
        gcalId: ev.id,
        title: ev.summary || 'ï¼ˆç„¡æ¨™é¡Œï¼‰',
        date: startDate,
        startTime, endTime,
        location: ev.location || '',
        description: ev.description || '',
        colorId: ev.colorId || null,
        isGcal: true,
        isAllDay,
        htmlLink: ev.htmlLink || '',
      };
    });

    gcalEventsCache[key] = events;
  } catch(e) {
    console.error('GCal fetch error:', e);
  }

  gcalLoading = false;
  if(statusEl) statusEl.innerHTML = '<span style="color:var(--green);">â—</span> å·²é€£ç·š';
}

function getGCalEventsForDate(ds) {
  const key = ds.slice(0, 7); // 'YYYY-MM'
  const events = gcalEventsCache[key] || [];
  return events.filter(e => e.date === ds);
}

function getGCalEventDates() {
  const dates = new Set();
  Object.values(gcalEventsCache).forEach(events => {
    events.forEach(e => dates.add(e.date));
  });
  return dates;
}

async function refreshGCalEvents() {
  gcalEventsCache = {};
  await fetchGCalMonthEvents(calYear, calMonth);
  renderSchedule();
  renderDashboard();
  toast('å·²é‡æ–°æ‹‰å– Google Calendar äº‹ä»¶','success');
}

// =============== WEBHOOK ===============
async function syncCal(action, data) {
  const s=getSett(); if(!s.whCalendar) { toast('æœªè¨­å®šè¡Œç¨‹ Webhook','error'); return; }
  // å°‡ localId åµŒå…¥ descriptionï¼Œè®“ Make.com Search å¾Œå¯ç²¾ç¢ºæ¯”å°
  const desc = `[PA:${data.id}][${data.category||'other'}] ${data.note||''}`.trim();
  // Google Calendar colorId å°æ‡‰
  const CAT_COLOR = { work:'7', personal:'4', meeting:'1', health:'5', other:'8' };
  try {
    const r=await fetch(s.whCalendar, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        action,
        localId: data.id,
        eventId: data.calendarEventId || null,
        title: data.title,
        date: data.date,
        startTime: data.startTime || null,
        endTime: data.endTime || null,
        location: data.location || '',
        description: desc,
        category: data.category || 'other',
        colorId: CAT_COLOR[data.category] || '8'
      })
    });
    if(r.ok) {
      const res=await r.json().catch(()=>({}));
      // ä¸ç®¡ create æˆ– updateï¼Œåªè¦å›å‚³ calendarEventId å°±å­˜èµ·ä¾†
      if(res.calendarEventId) {
        const l=get('schedules');
        const x=l.find(i=>i.id===data.id);
        if(x) { x.calendarEventId=res.calendarEventId; set('schedules',l); }
      }
      const statusMsg = {
        created:'å·²æ–°å¢è‡³ Google Calendar',
        updated:'å·²æ›´æ–° Google Calendar',
        deleted:'å·²å¾ Google Calendar åˆªé™¤',
        not_found:'Google Calendar æœªæ‰¾åˆ°äº‹ä»¶',
        updated_existing:'å·²æ›´æ–°æ—¢æœ‰ Google Calendar äº‹ä»¶'
      };
      toast(statusMsg[res.status]||'Google Calendar åŒæ­¥æˆåŠŸ','success');
    } else toast('åŒæ­¥å¤±æ•—','error');
  } catch{ toast('Webhook é€£ç·šå¤±æ•—','error'); }
}

async function testLine() {
  const s=getSett(); if(!s.whLine) { toast('æœªè¨­å®š LINE Webhook','error'); return; }
  const td=today();
  const scheds=get('schedules').filter(x=>x.date===td).sort((a,b)=>(a.startTime||'99').localeCompare(b.startTime||'99'));
  const todos=get('todos').filter(t=>!t.completed);
  let msg=`ğŸ“‹ æ¯æ—¥æ‘˜è¦ â€” ${fmtDateZh(new Date())}\n\nğŸ“… ä»Šæ—¥è¡Œç¨‹ï¼ˆ${scheds.length}ï¼‰\n`;
  scheds.forEach(s=>{ msg+=`  ${s.startTime||'å…¨å¤©'} ${s.title}${s.location?' ğŸ“'+s.location:''}\n`; });
  msg+=`\nâ˜‘ å¾…è¾¦ï¼ˆ${todos.length} é …æœªå®Œæˆï¼‰\n`;
  todos.filter(t=>PRI_ORDER[t.priority]<=1).slice(0,5).forEach(t=>{ msg+=`  ${PRI_LABEL[t.priority]} ${t.title}\n`; });
  try {
    const r=await fetch(s.whLine, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:'daily_summary', message:msg, date:td}) });
    toast(r.ok?'LINE æ¸¬è©¦å·²ç™¼é€':'ç™¼é€å¤±æ•—', r.ok?'success':'error');
  } catch{ toast('é€£ç·šå¤±æ•—','error'); }
}

// =============== DATA MANAGEMENT ===============
function exportData() {
  const d={schedules:get('schedules'),todos:get('todos'),notes:get('notes'),favorites:get('favorites'),settings:getSett(),exportedAt:new Date().toISOString()};
  const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`assistant-backup-${today()}.json`; a.click();
  toast('å·²åŒ¯å‡º','success');
}
function importData(e) {
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{ try { const d=JSON.parse(ev.target.result); if(d.schedules)set('schedules',d.schedules); if(d.todos)set('todos',d.todos); if(d.notes)set('notes',d.notes); if(d.favorites)set('favorites',d.favorites); if(d.settings){_cache.settings=d.settings; try{localStorage.setItem(SK.settings,JSON.stringify(d.settings));}catch{}} toast('åŒ¯å…¥æˆåŠŸ','success'); renderDashboard(); updateBadges(); } catch{toast('æ ¼å¼éŒ¯èª¤','error');} };
  r.readAsText(f); e.target.value='';
}
function clearAll() {
  if(!confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ')) return;
  Object.keys(SK).forEach(k => { _cache[k] = undefined; });
  Object.values(SK).forEach(k=>{ try { localStorage.removeItem(k); } catch{} });
  toast('å·²æ¸…é™¤','success'); loadDemo(); renderDashboard(); updateBadges();
}

// =============== HELPERS ===============
function esc(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
function updateBadges() {
  const td=today();
  document.getElementById('bSched').textContent=get('schedules').filter(s=>s.date===td).length;
  document.getElementById('bTodo').textContent=get('todos').filter(t=>!t.completed).length;
}

// =============== DEMO DATA ===============
function loadDemo() {
  // Always ensure favorites exist (independent of schedule/todo data)
  if(!get('favorites').length) {
    set('favorites',[
      {id:uid(),title:'åœ˜éšŠé€±æœƒ',category:'meeting',startTime:'09:00',endTime:'10:00',location:'3F æœƒè­°å®¤ A',note:'',syncCal:true,createdAt:new Date().toISOString()},
      {id:uid(),title:'å¥èº«è¨“ç·´',category:'health',startTime:'18:30',endTime:'19:30',location:'è¡¡é»å¥åº·',note:'',syncCal:false,createdAt:new Date().toISOString()},
      {id:uid(),title:'Code Review',category:'work',startTime:'15:00',endTime:'16:00',location:'Google Meet',note:'',syncCal:true,createdAt:new Date().toISOString()},
      {id:uid(),title:'åˆé¤',category:'personal',startTime:'12:00',endTime:'13:00',location:'',note:'',syncCal:false,createdAt:new Date().toISOString()},
    ]);
  }
  if(get('schedules').length||get('todos').length) return;
  const td=today(), tm=fmtDate(new Date(Date.now()+864e5)), yd=fmtDate(new Date(Date.now()-864e5)), da=fmtDate(new Date(Date.now()+864e5*2));
  set('schedules',[
    {id:uid(),title:'åœ˜éšŠé€±æœƒ',date:td,startTime:'09:00',endTime:'10:00',category:'meeting',location:'3F æœƒè­°å®¤ A',note:'è¨è«– Q1 é€²åº¦',syncCal:true,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),calendarEventId:null},
    {id:uid(),title:'ç³»çµ±é–‹ç™¼ â€” æ’ç­æ¨¡çµ„',date:td,startTime:'10:30',endTime:'12:30',category:'work',location:'',note:'Make.com æ•´åˆæ¸¬è©¦',syncCal:true,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),calendarEventId:null},
    {id:uid(),title:'åˆé¤ â€” å®¢æˆ¶é¤æ•˜',date:td,startTime:'12:30',endTime:'14:00',category:'personal',location:'æ¬£è‘‰å°èœ ä¿¡ç¾©åº—',note:'',syncCal:true,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),calendarEventId:null},
    {id:uid(),title:'Code Review',date:td,startTime:'15:00',endTime:'16:00',category:'work',location:'ç·šä¸Š Google Meet',note:'PR #42',syncCal:true,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),calendarEventId:null},
    {id:uid(),title:'å¥èº« â€” è…¿éƒ¨è¨“ç·´',date:td,startTime:'18:30',endTime:'19:30',category:'health',location:'è¡¡é»å¥åº·',note:'æ·±è¹²+è…¿æ¨+å¼“æ­¥è¹²',syncCal:false,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),calendarEventId:null},
    {id:uid(),title:'ç‰™é†«å›è¨º',date:tm,startTime:'10:00',endTime:'11:00',category:'health',location:'å“æ‚…ç‰™é†«',note:'',syncCal:true,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),calendarEventId:null},
  ]);
  set('todos',[
    {id:uid(),title:'å®Œæˆä»£èª²ç³»çµ±å³æ™‚èŠå¤©åŠŸèƒ½',priority:'urgent-important',dueDate:td,note:'Supabase Realtime',completed:false,createdAt:new Date().toISOString()},
    {id:uid(),title:'ä¿®å¾©æ•™ç·´æ’ç­é‡è¤‡å¯«å…¥å•é¡Œ',priority:'urgent-important',dueDate:td,note:'Make.com Router',completed:false,createdAt:new Date().toISOString()},
    {id:uid(),title:'æ’°å¯« API æ–‡ä»¶',priority:'important',dueDate:tm,note:'',completed:false,createdAt:new Date().toISOString()},
    {id:uid(),title:'è¨­è¨ˆæœƒå“¡è³‡æ–™ç¶å®šè¡¨å–® UI',priority:'important',dueDate:da,note:'LINE LIFF æ•´åˆ',completed:false,createdAt:new Date().toISOString()},
    {id:uid(),title:'å›è¦†åˆä½œå» å•†å ±åƒ¹ä¿¡',priority:'urgent',dueDate:td,note:'',completed:false,createdAt:new Date().toISOString()},
    {id:uid(),title:'æ›´æ–° Google Sheets åŒæ­¥è…³æœ¬',priority:'urgent',dueDate:tm,note:'Apps Script',completed:false,createdAt:new Date().toISOString()},
    {id:uid(),title:'æäº¤ä¸Šé€±å·¥æ™‚è¡¨',priority:'urgent',dueDate:yd,note:'',completed:false,createdAt:new Date().toISOString()},
    {id:uid(),title:'å»ºç«‹ MySQL å‚™ä»½æ’ç¨‹',priority:'important',dueDate:yd,note:'',completed:false,createdAt:new Date().toISOString()},
    {id:uid(),title:'ç ”ç©¶ LINE Messaging API',priority:'normal',dueDate:'',note:'Flex Message',completed:false,createdAt:new Date().toISOString()},
    {id:uid(),title:'æ•´ç† Docker è¨­å®š',priority:'normal',dueDate:'',note:'',completed:false,createdAt:new Date().toISOString()},
    {id:uid(),title:'éƒ¨ç½²æ’ç­ç³»çµ±åˆ°æ­£å¼ç’°å¢ƒ',priority:'urgent-important',dueDate:td,note:'',completed:true,completedAt:new Date().toISOString(),createdAt:new Date(Date.now()-864e5).toISOString()},
    {id:uid(),title:'ä¿®å¾© LIFF token éæœŸå•é¡Œ',priority:'urgent-important',dueDate:yd,note:'',completed:true,completedAt:new Date().toISOString(),createdAt:new Date(Date.now()-864e5*2).toISOString()},
    {id:uid(),title:'å®Œæˆè©¦ä¸Šèª²å›é¥‹è¡¨å–®',priority:'important',dueDate:yd,note:'',completed:true,completedAt:new Date().toISOString(),createdAt:new Date(Date.now()-864e5*3).toISOString()},
  ]);
  set('notes',[
    {id:uid(),title:'ä¸‰å¸³è™Ÿæ¶æ§‹é·ç§»ç­†è¨˜',content:'å®¢æœå¸³è™Ÿï¼šæœƒå“¡äº’å‹•ã€é ç´„é€šçŸ¥\næ•™å­¸å¸³è™Ÿï¼šèª²ç¨‹æé†’ã€æ•™ç·´æºé€š\nç®¡ç†å¸³è™Ÿï¼šå…§éƒ¨è¡Œæ”¿ã€æ’ç­ç®¡ç†',tags:['LINE','æ¶æ§‹','è¡¡é»å¥åº·'],createdAt:new Date(Date.now()-864e5*2).toISOString(),updatedAt:new Date(Date.now()-864e5).toISOString()},
    {id:uid(),title:'Make.com æˆæœ¬å„ªåŒ–æ–¹æ¡ˆ',content:'åˆä½µé‡è¤‡ scenarioï¼Œç”¨ Router å–ä»£å¤šå€‹ webhookï¼Œæ‰¹æ¬¡è™•ç†å–ä»£é€ç­†è§¸ç™¼',tags:['Make.com','æˆæœ¬'],createdAt:new Date(Date.now()-864e5*5).toISOString(),updatedAt:new Date(Date.now()-864e5*3).toISOString()},
    {id:uid(),title:'Supabase Realtime æ¸¬è©¦çµæœ',content:'å»¶é²ç´„ 50-100msï¼Œå…è²»æ–¹æ¡ˆ 200 concurrent connectionsï¼Œæ­é… MySQL æŒä¹…åŒ–',tags:['Supabase','æŠ€è¡“ç­†è¨˜'],createdAt:new Date(Date.now()-864e5*4).toISOString(),updatedAt:new Date(Date.now()-864e5*4).toISOString()},
    {id:uid(),title:'æœƒå“¡å¥åº·å•å·è¦åŠƒ',content:'åŸºæœ¬è³‡æ–™ï¼šèº«é«˜ã€é«”é‡ã€BMI\nå¥åº·å²ï¼šç—…å²ã€æ‰‹è¡“ã€ç”¨è—¥\nAI å§¿æ…‹åˆ†ææ•´åˆ',tags:['è¡¡é»å¥åº·','å•å·'],createdAt:new Date(Date.now()-864e5*7).toISOString(),updatedAt:new Date(Date.now()-864e5*6).toISOString()},
    {id:uid(),title:'ä¸‹é€±è¦è²·çš„æ±è¥¿',content:'æ©Ÿæ¢°éµç›¤ï¼ˆèŒ¶è»¸ï¼‰ã€USB-C Hubã€è¢å¹•æ¶ã€å’–å•¡è±†',tags:['å€‹äºº','è³¼ç‰©'],createdAt:new Date(Date.now()-864e5).toISOString(),updatedAt:new Date(Date.now()-864e5).toISOString()},
    {id:uid(),title:'å¹´åº¦ç›®æ¨™ 2026',content:'æŠ€è¡“ï¼šå®Œæˆè¡¡é»å¥åº·å…¨ç³»çµ±\nå­¸ç¿’ï¼šTypeScript + Next.js\nå¥åº·ï¼šæ¯é€±è¨“ç·´ 3 æ¬¡',tags:['ç›®æ¨™','å¹´åº¦è¨ˆç•«'],createdAt:new Date(Date.now()-864e5*30).toISOString(),updatedAt:new Date(Date.now()-864e5*2).toISOString()},
  ]);
}

// =============== INIT ===============
function init() {
  const now=new Date();
  document.getElementById('hDate').textContent = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')} ${DAYS[now.getDay()]}`;
  loadDemo();
  updateBadges();
  renderDashboard();
  // Pre-fetch current month Google Calendar events (if token exists from this session)
  if(gcalToken) {
    fetchGCalMonthEvents(now.getFullYear(), now.getMonth()).then(() => { renderDashboard(); updateBadges(); });
  }
}
init();
</script>
</body>
</html>
